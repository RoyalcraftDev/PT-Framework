name: Build PT-Framework

on:
    workflow_dispatch:

permissions:
  contents: write
  discussions: write

jobs:
    build:
        runs-on: ${{ matrix.os }}
        
        strategy:
          matrix:
            include:
            - os: windows-latest
              targetFramework: net9.0-windows
              runtimeIdentifier: win-x64
            - os: windows-latest
              targetFramework: net9.0-android
              runtimeIdentifier: win-x64
            - os: macos-latest
              targetFramework: net9.0
              runtimeIdentifier: osx-x64
            - os: macos-latest
              targetFramework: net9.0-ios
              runtimeIdentifier: osx-x64
            - os: ubuntu-latest
              targetFramework: net9.0
              runtimeIdentifier: linux-x64
        
        steps:
        - name: Checkout repository
          uses: actions/checkout@v4.2.2

        - name: Setup .NET Core SDK
          uses: actions/setup-dotnet@v4.2.0
          with:
            dotnet-version: 9.0.x
      
        - name: Install workloads
          run: |
            if [[ "${{ matrix.targetFramework }}" == *"ios" ]]; then
              dotnet workload install ios;
            elif [[ "${{ matrix.targetFramework }}" == *"android" ]]; then
              dotnet workload install android;
            fi
        
        - name: Restore project dependencies
          run: dotnet restore PT-Framework.csproj
        
        - name: Publish build artifacts
          run: dotnet publish PT-Framework.csproj --configuration Release --framework ${{ matrix.targetFramework }} -r ${{ matrix.runtimeIdentifier }} --output ./artifacts/${{ matrix.os }}/${{ matrix.targetFramework }}-${{ matrix.runtimeIdentifier }}
        
        - name: Archive artifacts
          run: |
            mkdir -p ./releases
            zip -r ./releases/PT-Framework-${{ matrix.os }}-${{ matrix.targetFramework }}-${{ matrix.runtimeIdentifier }}.zip ./artifacts/${{ matrix.os }}/${{ matrix.targetFramework }}-${{ matrix.runtimeIdentifier }}
        
        - name: Upload release to GitHub
          uses: softprops/action-gh-release@v2.2.1
          with:
            files: ./releases/*.zip
            tag_name: testing-phase
            name: "Testing Phase Release"
            draft: false
            prerelease: true
            generate_release_notes: true
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
